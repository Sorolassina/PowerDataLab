{% extends "base.html" %}

{% block title %}{% if article %}Modifier l'article{% else %}Nouvel article{% endif %} - PowerDataLab{% endblock %}

{% block extra_css %}
{{ super() }}
<!-- Inclusion des styles CodeMirror 5 -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/monokai.min.css">
<style>
/* Layout principal */
.admin-container {
    display: flex;
    gap: 2rem;
    margin: 2rem auto;
    max-width: 1600px;
    width: 95%;
}

.admin-sidebar {
    width: 250px;
    flex-shrink: 0;
    background: #f8f9fa;
    padding: 1rem;
    border-radius: 8px;
    height: fit-content;
}

.admin-menu {
    list-style: none;
    padding: 0;
    margin: 0;
}

.admin-menu li {
    margin-bottom: 0.5rem;
}

.admin-menu a {
    display: block;
    padding: 0.75rem 1rem;
    color: #333;
    text-decoration: none;
    border-radius: 4px;
    transition: all 0.3s ease;
}

.admin-menu a:hover,
.admin-menu a.active {
    background: #007bff;
    color: white;
}

.admin-menu i {
    margin-right: 0.5rem;
    width: 20px;
    text-align: center;
}

.admin-content {
    flex: 1;
    min-width: 0;
}

/* Styles du formulaire */
.article-form {
    background: white;
    padding: 1rem;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    width: 100%;
    display: flex;
    flex-direction: column;
    flex: 1;
    overflow: hidden;
}

/* Styles pour l'accordéon */
.accordion {
    flex: 1;
    display: flex;
    flex-direction: column;
}

.accordion-item {
    border: 1px solid #dee2e6;
    border-radius: 8px !important;
    margin-bottom: 0.5rem;
}

.accordion-button {
    background-color: #f8f9fa;
    border: none;
    font-weight: 500;
    padding: 1rem 1.5rem;
}

.accordion-button:not(.collapsed) {
    background-color: #e9ecef;
    color: #495057;
}

.accordion-button:focus {
    box-shadow: 0 0 0 0.25rem rgba(0,123,255,.25);
}

.accordion-body {
    padding: 1.5rem;
}

/* Section contenu - taille fixe pour l'éditeur */
#collapseContent .accordion-body {
    padding: 1rem;
    height: 500px;
    display: flex;
    flex-direction: column;
}

.form-group {
    margin-bottom: 2rem;
}

/* Groupe de formulaire pour le contenu - taille fixe */
.form-group.content-group {
    flex-shrink: 0;
    display: flex;
    flex-direction: column;
    margin-bottom: 2rem;
}

.form-control {
    width: 100%;
    padding: 0.5rem;
    border: 1px solid #ddd;
    border-radius: 4px;
}

.form-control:focus {
    border-color: #007bff;
    outline: none;
    box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
}

.form-actions {
    display: flex;
    gap: 1rem;
    margin-top: 2rem;
}

/* Styles pour CodeMirror 5 */
#editor {
    height: 400px;
    margin-bottom: 1rem;
    border: 1px solid #ddd;
    border-radius: 4px;
    overflow: hidden;
}

.CodeMirror {
    height: 100%;
    font-size: 16px;
    line-height: 1.6;
    font-family: 'Fira Code', 'Monaco', 'Consolas', 'Courier New', monospace;
}

.CodeMirror-focused {
    outline: none;
}

.CodeMirror-scroll {
    height: 100%;
}

/* Styles pour la barre d'outils */
.editor-toolbar {
    display: flex;
    gap: 0.5rem;
    padding: 0.5rem;
    background: #f8f9fa;
    border-bottom: 1px solid #ddd;
    border-radius: 4px 4px 0 0;
}

.editor-toolbar button {
    padding: 0.5rem 1rem;
    border: 1px solid #ddd;
    background: white;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.2s;
}

.editor-toolbar button:hover {
    background: #e9ecef;
    border-color: #007bff;
}

.editor-toolbar button.active {
    background: #007bff;
    color: white;
    border-color: #007bff;
}

.editor-toolbar select {
    padding: 0.5rem;
    border: 1px solid #ddd;
    border-radius: 4px;
    background: white;
    cursor: pointer;
}

/* Styles pour la galerie d'images */
.image-gallery {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 1rem;
    margin-top: 1rem;
}

.image-item {
    position: relative;
    border: 1px solid #ddd;
    padding: 0.5rem;
    text-align: center;
}

.image-item img {
    width: 100%;
    height: 150px;
    object-fit: cover;
}

.image-item .remove-image {
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.image-item:hover .remove-image {
    opacity: 1;
}

.image-handle {
    position: absolute;
    top: 0.5rem;
    left: 0.5rem;
    background: rgba(0, 0, 0, 0.5);
    color: white;
    padding: 0.25rem;
    border-radius: 4px;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.image-item:hover .image-handle {
    opacity: 1;
}

.image-item.sortable-ghost {
    opacity: 0.5;
}

.image-item.sortable-chosen {
    box-shadow: 0 0 10px rgba(0,0,0,0.2);
}

.article-video {
    width: 100%;
    max-height: 300px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.form-text {
    font-size: 0.875rem;
    color: #6c757d;
    margin-top: 0.25rem;
}

/* Ajustements responsifs */
@media (max-width: 1200px) {
    .admin-container {
        flex-direction: column;
    }
    
    .admin-sidebar {
        width: 100%;
    }
    
    .admin-menu {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
    }
    
    .admin-menu li {
        margin: 0;
    }
    
    .article-form {
        max-height: 70vh;
        min-height: 400px;
    }
    
    #collapseContent .accordion-body {
        height: 400px;
    }
    
    #editor {
        height: 300px;
        max-height: 300px;
    }
    
    .CodeMirror {
        height: 300px;
        max-height: 300px;
    }
    
    .CodeMirror-scroll {
        height: 300px;
        max-height: 300px;
    }
}

@media (max-width: 768px) {
    .article-form {
        max-height: 60vh;
        min-height: 350px;
        padding: 1rem;
    }
    
    #collapseContent .accordion-body {
        height: 350px;
    }
    
    #editor {
        height: 250px;
        max-height: 250px;
    }
    
    .CodeMirror {
        height: 250px;
        max-height: 250px;
    }
    
    .CodeMirror-scroll {
        height: 250px;
        max-height: 250px;
    }
    
    .editor-toolbar {
        flex-wrap: wrap;
        gap: 0.25rem;
    }
    
    .editor-toolbar button {
        padding: 0.25rem 0.5rem;
        font-size: 12px;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="admin-container">
    <div class="admin-sidebar">
        <ul class="admin-menu">
            <li><a href="{{ url_for('admin.admin_dashboard') }}"><i class="fas fa-tachometer-alt"></i> Tableau de bord</a></li>
            <li><a href="{{ url_for('article.manage_articles') }}" class="active"><i class="fas fa-list"></i> Gérer les articles</a></li>
            <li><a href="{{ url_for('comment.manage_comments') }}"><i class="fas fa-comments"></i> Commentaires</a></li>
            <li><a href="{{ url_for('admin.manage_newsletter') }}"><i class="fas fa-envelope"></i> Newsletter</a></li>
        </ul>
    </div>

    <div class="admin-content">
        <h1>{% if article %}Modifier l'article{% else %}Nouvel article{% endif %}</h1>
        
        <form method="POST" enctype="multipart/form-data" class="article-form">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            
            <!-- Accordéon Bootstrap -->
            <div class="accordion" id="articleAccordion">
                <!-- Section Informations de base -->
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingBasic">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseBasic" aria-expanded="false" aria-controls="collapseBasic">
                            <i class="fas fa-info-circle me-2"></i> Informations de base
                        </button>
                    </h2>
                    <div id="collapseBasic" class="accordion-collapse collapse" aria-labelledby="headingBasic" data-bs-parent="#articleAccordion">
                        <div class="accordion-body">
                            <div class="form-group">
                                <label for="title">Titre</label>
                                <input type="text" class="form-control" id="title" name="title" value="{{ article.title if article else '' }}" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="category_id">Catégorie</label>
                                <select class="form-control" id="category_id" name="category_id" required>
                                    <option value="">Sélectionner une catégorie</option>
                                    {% for category in categories %}
                                    <option value="{{ category.id }}" {% if article and article.category_id == category.id %}selected{% endif %}>
                                        {{ category.name }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Section Contenu -->
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingContent">
                        <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseContent" aria-expanded="true" aria-controls="collapseContent">
                            <i class="fas fa-edit me-2"></i> Contenu de l'article
                        </button>
                    </h2>
                    <div id="collapseContent" class="accordion-collapse collapse show" aria-labelledby="headingContent" data-bs-parent="#articleAccordion">
                        <div class="accordion-body content-group">
                            <label for="content">Contenu</label>
                            <!-- Barre d'outils pour CodeMirror -->
                            <div class="editor-toolbar">
                                <button type="button" id="toggle-mode" title="Basculer entre mode texte et code">
                                    <i class="fas fa-code"></i> Mode Code
                                </button>
                                <select id="language-select">
                                    <option value="markdown">Markdown</option>
                                    <option value="python">Python</option>
                                    <option value="dax">DAX</option>
                                    <option value="sql">SQL</option>
                                    <option value="javascript">JavaScript</option>
                                    <option value="html">HTML</option>
                                    <option value="css">CSS</option>
                                    <option value="json">JSON</option>
                                    <option value="powershell">PowerShell</option>
                                    <option value="bash">Bash</option>
                                </select>
                                <button type="button" id="insert-code-block" title="Insérer un bloc de code">
                                    <i class="fas fa-terminal"></i> Code
                                </button>
                                <button type="button" id="insert-link" title="Insérer un lien">
                                    <i class="fas fa-link"></i> Lien
                                </button>
                                <button type="button" id="insert-image" title="Insérer une image">
                                    <i class="fas fa-image"></i> Image
                                </button>
                            </div>
                            <!-- Div pour CodeMirror -->
                            <div id="editor"></div>
                            <!-- Textarea caché pour stocker le contenu -->
                            <textarea style="display: none;" id="content" name="content">{{ article.content if article else '' }}</textarea>
                        </div>
                    </div>
                </div>

                <!-- Section Documents -->
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingDocuments">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseDocuments" aria-expanded="false" aria-controls="collapseDocuments">
                            <i class="fas fa-file-alt me-2"></i> Documents
                        </button>
                    </h2>
                    <div id="collapseDocuments" class="accordion-collapse collapse" aria-labelledby="headingDocuments" data-bs-parent="#articleAccordion">
                        <div class="accordion-body">
                            <div class="form-group">
                                <label for="documents">Documents (PDF, Word, Excel, etc.)</label>
                                <input type="file" class="form-control" id="documents" name="documents" multiple 
                                       accept=".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx">
                                {% if article and article.documents %}
                                <div class="mt-3">
                                    <h5>Documents actuels :</h5>
                                    <ul class="list-group">
                                        {% for doc in article.documents %}
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            <span>
                                                <i class="fas fa-file me-2"></i>
                                                {{ doc.original_filename }}
                                            </span>
                                            <div>
                                                <a href="{{ url_for('uploads.serve_upload', filename=doc.filename) }}" 
                                                   class="btn btn-sm btn-primary me-2" target="_blank">
                                                    <i class="fas fa-download"></i>
                                                </a>
                                                <button type="button" class="btn btn-sm btn-danger" 
                                                        onclick="deleteDocument('{{ doc.id }}')"
                                                        title="Supprimer le document">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </li>
                                        {% endfor %}
                                    </ul>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Section Images -->
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingImages">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseImages" aria-expanded="false" aria-controls="collapseImages">
                            <i class="fas fa-images me-2"></i> Images
                        </button>
                    </h2>
                    <div id="collapseImages" class="accordion-collapse collapse" aria-labelledby="headingImages" data-bs-parent="#articleAccordion">
                        <div class="accordion-body">
                            <div class="form-group">
                                <label for="images">Images</label>
                                <input type="file" class="form-control" id="images" name="images" accept="image/*" multiple>
                                <small class="form-text text-muted">Vous pouvez sélectionner plusieurs images. Formats acceptés : PNG, JPG, JPEG, GIF</small>
                                
                                {% if article and article.image_path %}
                                <div class="current-images mt-3">
                                    <h5>Images actuelles :</h5>
                                    <div class="image-gallery" id="sortable-gallery">
                                        {% for image_path in article.image_path.split(',') if image_path.strip() %}
                                        <div class="image-item" data-path="{{ image_path }}">
                                            <img src="{{ url_for('uploads.serve_upload', filename=image_path.replace('uploads/', '')) }}" alt="Image de l'article">
                                            <button type="button" class="btn btn-danger btn-sm remove-image" 
                                                    data-path="{{ image_path }}"
                                                    title="Supprimer l'image">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                            <div class="image-handle">
                                                <i class="fas fa-grip-vertical"></i>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                    <input type="hidden" name="existing_images" id="existing-images" value="{{ article.image_path }}">
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Section Vidéo -->
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingVideo">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseVideo" aria-expanded="false" aria-controls="collapseVideo">
                            <i class="fas fa-video me-2"></i> Vidéo
                        </button>
                    </h2>
                    <div id="collapseVideo" class="accordion-collapse collapse" aria-labelledby="headingVideo" data-bs-parent="#articleAccordion">
                        <div class="accordion-body">
                            <div class="form-group">
                                <label for="video">Vidéo de l'article</label>
                                <input type="file" class="form-control" id="video" name="video" accept="video/*">
                                {% if article and article.video_path %}
                                <div class="mt-3">
                                    <h5>Vidéo actuelle :</h5>
                                    <video controls class="article-video" style="width: 100%; max-height: 300px;">
                                        <source src="{{ url_for('uploads.serve_upload', filename=article.video_path.replace('uploads/', '')) }}" type="video/mp4">
                                        Votre navigateur ne supporte pas la lecture de vidéos.
                                    </video>
                                </div>
                                {% endif %}
                                <small class="text-muted">Formats acceptés : MP4, AVI, MOV, WMV, FLV, WEBM, MKV<br>Taille maximale : 500 MB</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="form-actions">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i> {% if article %}Mettre à jour{% else %}Créer{% endif %}
                </button>
                <a href="{{ url_for('article.manage_articles') }}" class="btn btn-secondary">
                    <i class="fas fa-times"></i> Annuler
                </a>
            </div>
        </form>
    </div>
</div>

{% if article %}
<script>
// Suppression de document
window.deleteDocument = function(documentId) {
    if (confirm('Êtes-vous sûr de vouloir supprimer ce document ?')) {
        const csrfToken = document.querySelector('meta[name="csrf-token"]').content;
        
        fetch(`/admin/article/document/${documentId}/delete`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            credentials: 'same-origin'
        })
        .then(response => {
            if (!response.ok) {
                if (response.headers.get('content-type')?.includes('text/html')) {
                    throw new Error('Session expirée. Veuillez rafraîchir la page.');
                }
                return response.json().then(data => {
                    throw new Error(data.error || 'Erreur lors de la suppression du document');
                });
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                // Supprimer l'élément de la liste
                const documentElement = document.querySelector(`[data-document-id="${documentId}"]`);
                if (documentElement) {
                    documentElement.remove();
                }
                // Recharger la page si plus de documents
                const documentsList = document.querySelector('.list-group');
                if (documentsList && documentsList.children.length === 0) {
                    location.reload();
                }
            } else {
                throw new Error(data.error || 'Erreur lors de la suppression du document');
            }
        })
        .catch(error => {
            console.error('Erreur:', error);
            alert(error.message || 'Erreur lors de la suppression du document');
            if (error.message.includes('Session expirée')) {
                location.reload();
            }
        });
    }
};
</script>
{% endif %}
{% endblock %}

{% block extra_js %}
{{ super() }}
<!-- CodeMirror 5 (plus stable avec CDN) -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/monokai.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/markdown/markdown.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/python/python.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/sql/sql.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/javascript/javascript.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/xml/xml.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/css/css.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/javascript/javascript.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let editor;
    let currentMode = 'markdown';
    let isCodeMode = false;

    // Fonction pour créer l'éditeur
    function createEditor(mode = 'markdown') {
        const editorElement = document.getElementById('editor');
        
        // Configuration de CodeMirror 5
        const config = {
            lineNumbers: true,
            theme: isCodeMode ? 'monokai' : 'default',
            mode: mode,
            indentUnit: 4,
            tabSize: 4,
            lineWrapping: true,
            autofocus: true,
            value: document.getElementById('content').value || '',
            viewportMargin: Infinity,
            autoRefresh: true
        };

        // Créer l'éditeur
        editor = CodeMirror(editorElement, config);
        
        // Écouter les changements
        editor.on('change', function() {
            document.getElementById('content').value = editor.getValue();
        });
        
        // Redimensionner automatiquement l'éditeur avec taille fixe
        function resizeEditor() {
            editor.setSize(null, '400px');
        }
        
        // Redimensionner immédiatement
        setTimeout(resizeEditor, 100);
        
        // Gérer le redimensionnement de la fenêtre
        window.addEventListener('resize', function() {
            const isMobile = window.innerWidth <= 768;
            const isTablet = window.innerWidth <= 1200;
            
            if (isMobile) {
                editor.setSize(null, '250px');
            } else if (isTablet) {
                editor.setSize(null, '300px');
            } else {
                editor.setSize(null, '400px');
            }
        });
    }

    // Initialiser l'éditeur
    createEditor();

    // Gestionnaire pour le changement de mode
    document.getElementById('language-select').addEventListener('change', function() {
        const newMode = this.value;
        if (newMode !== currentMode) {
            currentMode = newMode;
            editor.setOption('mode', newMode);
        }
    });

    // Gestionnaire pour basculer entre mode texte et code
    document.getElementById('toggle-mode').addEventListener('click', function() {
        isCodeMode = !isCodeMode;
        const button = this;
        
        if (isCodeMode) {
            button.innerHTML = '<i class="fas fa-file-alt"></i> Mode Texte';
            button.classList.add('active');
            editor.setOption('theme', 'monokai');
        } else {
            button.innerHTML = '<i class="fas fa-code"></i> Mode Code';
            button.classList.remove('active');
            editor.setOption('theme', 'default');
        }
    });

    // Gestionnaire pour insérer un bloc de code
    document.getElementById('insert-code-block').addEventListener('click', function() {
        const language = document.getElementById('language-select').value;
        const codeBlock = `\`\`\`${language}\n// Votre code ici\n\`\`\`\n\n`;
        
        const cursor = editor.getCursor();
        editor.replaceRange(codeBlock, cursor);
        
        // Positionner le curseur dans le bloc de code
        const newCursor = {
            line: cursor.line + 1,
            ch: 0
        };
        editor.setCursor(newCursor);
        editor.focus();
    });

    // Gestionnaire pour insérer un lien
    document.getElementById('insert-link').addEventListener('click', function() {
        const linkText = prompt('Texte du lien:');
        const linkUrl = prompt('URL du lien:');
        
        if (linkText && linkUrl) {
            const linkMarkdown = `[${linkText}](${linkUrl})`;
            const cursor = editor.getCursor();
            editor.replaceRange(linkMarkdown, cursor);
            editor.focus();
        }
    });

    // Gestionnaire pour insérer une image
    document.getElementById('insert-image').addEventListener('click', function() {
        const imageAlt = prompt('Texte alternatif de l\'image:');
        const imageUrl = prompt('URL de l\'image:');
        
        if (imageAlt && imageUrl) {
            const imageMarkdown = `![${imageAlt}](${imageUrl})`;
            const cursor = editor.getCursor();
            editor.replaceRange(imageMarkdown, cursor);
            editor.focus();
        }
    });

    // Synchronisation avec le textarea caché
    const form = document.querySelector('form');
    const contentInput = document.querySelector('#content');

    // Mettre à jour le textarea avant la soumission du formulaire
    form.addEventListener('submit', function() {
        contentInput.value = editor.getValue();
        return true;
    });
});
</script>
{% endblock %}
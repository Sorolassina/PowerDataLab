{% extends "base.html" %}

{% block title %}{{ "Modifier" if project else "Nouveau" }} Projet - Admin{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-8 mx-auto">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h2 class="card-title mb-4">
                        {{ "Modifier" if project else "Nouveau" }} Projet
                    </h2>

                    <form method="POST" enctype="multipart/form-data">
                        {{ form.csrf_token }}
                        
                        <!-- Titre -->
                        <div class="mb-3">
                            {{ form.title.label(class="form-label") }}
                            {{ form.title(class="form-control" + (" is-invalid" if form.title.errors else "")) }}
                            {% if form.title.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.title.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        <!-- Description -->
                        <div class="mb-3">
                            {{ form.description.label(class="form-label") }}
                            {{ form.description(class="form-control" + (" is-invalid" if form.description.errors else ""), rows="4") }}
                            {% if form.description.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.description.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        <!-- Catégorie -->
                        <div class="mb-3">
                            {{ form.category.label(class="form-label") }}
                            {{ form.category(class="form-select" + (" is-invalid" if form.category.errors else "")) }}
                            {% if form.category.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.category.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        <!-- Technologies -->
                        <div class="mb-3">
                            {{ form.technologies.label(class="form-label") }}
                            {{ form.technologies(class="form-control" + (" is-invalid" if form.technologies.errors else ""), placeholder="Séparez les technologies par des virgules") }}
                            {% if form.technologies.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.technologies.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <small class="text-muted">Ex: Python, Flask, Bootstrap</small>
                        </div>

                        <!-- URLs -->
                        <div class="mb-3">
                            {{ form.demo_url.label(class="form-label") }}
                            {{ form.demo_url(class="form-control" + (" is-invalid" if form.demo_url.errors else "")) }}
                            {% if form.demo_url.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.demo_url.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            {{ form.github_url.label(class="form-label") }}
                            {{ form.github_url(class="form-control" + (" is-invalid" if form.github_url.errors else "")) }}
                            {% if form.github_url.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.github_url.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        <!-- Image -->
                        <div class="mb-3">
                            {{ form.image.label(class="form-label") }}
                            {{ form.image(class="form-control" + (" is-invalid" if form.image.errors else "")) }}
                            {% if form.image.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.image.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                            {% if project and project.image_path %}
                                <div class="mt-2">
                                    <img src="{{ url_for('static', filename=project.image_path) }}" 
                                         alt="Image actuelle" 
                                         class="img-thumbnail" 
                                         style="max-height: 200px;">
                                </div>
                            {% endif %}
                        </div>

                        <!-- Documents -->
                        <div class="mb-3">
                            {{ form.documents.label(class="form-label") }}
                            {{ form.documents(class="form-control" + (" is-invalid" if form.documents.errors else "")) }}
                            {% if form.documents.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.documents.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                            {% if project and project.documents %}
                                <div class="mt-3">
                                    <h6>Documents actuels :</h6>
                                    <ul class="list-group">
                                        {% for doc in project.documents %}
                                        <li class="list-group-item d-flex justify-content-between align-items-center" data-document-id="{{ doc.id }}">
                                            <span>
                                                <i class="fas fa-file me-2"></i>
                                                {{ doc.original_filename }}
                                            </span>
                                            <div>
                                                <a href="{{ url_for('project.download_document', document_id=doc.id) }}" 
                                                   class="btn btn-sm btn-outline-primary me-2"
                                                   title="Télécharger {{ doc.original_filename }}">
                                                    <i class="fas fa-download"></i>
                                                </a>
                                                <button type="button" 
                                                        class="btn btn-sm btn-outline-danger"
                                                        onclick="deleteDocument({{ doc.id }})"
                                                        title="Supprimer {{ doc.original_filename }}">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            {% endif %}
                            <small class="text-muted">
                                Formats acceptés : PDF, Word, TXT, Markdown, PowerPoint, Excel
                            </small>
                        </div>

                        <!-- Statut du projet -->
                        <div class="mb-3">
                            {{ form.status.label(class="form-label") }}
                            {{ form.status(class="form-select" + (" is-invalid" if form.status.errors else "")) }}
                            {% if form.status.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.status.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <small class="text-muted">
                                <i class="fas fa-tools"></i> En cours - 
                                <i class="fas fa-check-circle"></i> Terminé - 
                                <i class="fas fa-archive"></i> Archivé - 
                                <i class="fas fa-times-circle"></i> Annulé - 
                                <i class="fas fa-pause-circle"></i> En pause
                            </small>
                        </div>

                        <!-- Projet phare -->
                        <div class="mb-4">
                            <div class="form-check">
                                {{ form.is_featured(class="form-check-input") }}
                                {{ form.is_featured.label(class="form-check-label") }}
                            </div>
                        </div>

                        <!-- Boutons -->
                        <div class="d-flex justify-content-between">
                            <a href="{{ url_for('project.projects') }}" class="btn btn-outline-secondary">
                                <i class="fas fa-arrow-left me-2"></i>Retour
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-2"></i>{{ "Mettre à jour" if project else "Créer" }}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.card {
    border: none;
}

.form-control:focus,
.form-select:focus {
    border-color: var(--primary);
    box-shadow: 0 0 0 0.2rem rgba(var(--primary-rgb), 0.25);
}

.form-check-input:checked {
    background-color: var(--primary);
    border-color: var(--primary);
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Prévisualisation de l'image
    const imageInput = document.querySelector('input[type="file"]');
    const previewContainer = document.createElement('div');
    previewContainer.className = 'mt-2';
    imageInput.parentNode.appendChild(previewContainer);

    imageInput.addEventListener('change', function() {
        previewContainer.innerHTML = '';
        if (this.files && this.files[0]) {
            const img = document.createElement('img');
            img.className = 'img-thumbnail';
            img.style.maxHeight = '200px';
            img.src = URL.createObjectURL(this.files[0]);
            previewContainer.appendChild(img);
        }
    });

    // Suppression de document
    window.deleteDocument = function(documentId) {
        if (confirm('Êtes-vous sûr de vouloir supprimer ce document ?')) {
            fetch(`/admin/projects/documents/${documentId}/delete`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Supprimer l'élément de la liste
                    const documentElement = document.querySelector(`[data-document-id="${documentId}"]`);
                    if (documentElement) {
                        documentElement.remove();
                    }
                    // Recharger la page si plus de documents
                    const documentsList = document.querySelector('.list-group');
                    if (documentsList && documentsList.children.length === 0) {
                        location.reload();
                    }
                } else {
                    alert('Erreur lors de la suppression du document');
                }
            })
            .catch(error => {
                console.error('Erreur:', error);
                alert('Erreur lors de la suppression du document');
            });
        }
    };
});
</script>
{% endblock %}